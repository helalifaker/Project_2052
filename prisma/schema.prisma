generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String         @id @default(uuid())
  email          String         @unique
  name           String
  role           Role           @default(VIEWER)
  approvalStatus ApprovalStatus @default(PENDING)
  approvedBy     String?        /// ID of admin who approved/rejected
  approvedAt     DateTime?      /// When approval decision was made
  rejectionReason String?       /// Optional reason for rejection
  createdAt      DateTime       @default(now())

  // Relations
  proposalsCreated           LeaseProposal[]        @relation("ProposalCreator")
  negotiationsCreated        Negotiation[]          @relation("NegotiationCreator")
  configUpdates              SystemConfig[]         @relation("ConfigUpdater")
  scenariosCreated           Scenario[]             @relation("ScenarioCreator")
  sensitivityAnalysesCreated SensitivityAnalysis[]  @relation("SensitivityAnalysisCreator")

  @@index([approvalStatus])
  @@index([role, approvalStatus]) // PERF: Admin user filtering by role + status
}

enum Role {
  ADMIN
  PLANNER
  VIEWER
}

enum ApprovalStatus {
  PENDING    // Awaiting admin approval
  APPROVED   // Can access the application
  REJECTED   // Access denied
}

enum ProposalOrigin {
  OUR_OFFER
  THEIR_COUNTER
}

enum ProposalStatus {
  DRAFT
  READY_TO_SUBMIT
  SUBMITTED
  UNDER_REVIEW
  COUNTER_RECEIVED
  EVALUATING_COUNTER
  ACCEPTED
  REJECTED
  NEGOTIATION_CLOSED
}

enum NegotiationStatus {
  ACTIVE
  ACCEPTED
  REJECTED
  CLOSED
}

enum ProposalPurpose {
  NEGOTIATION   // Part of a negotiation workflow
  STRESS_TEST   // What-if analysis after negotiation finalized
  SIMULATION    // Standalone simulation (default)
}

enum CapExCategoryType {
  IT_EQUIPMENT
  FURNITURE
  EDUCATIONAL_EQUIPMENT
  BUILDING
}

model SystemConfig {
  id                  String    @id @default(uuid())
  zakatRate           Decimal   @default(0.025)
  debtInterestRate    Decimal   @default(0.05)
  depositInterestRate Decimal   @default(0.02)
  discountRate        Decimal   @default(0.08)  // NPV discount rate (WACC/hurdle rate)
  minCashBalance      Decimal   @default(1000000)
  confirmedAt         DateTime?
  updatedBy           String?

  // Relations
  updater User? @relation("ConfigUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
}

model HistoricalData {
  id            String   @id @default(uuid())
  year          Int
  statementType String
  lineItem      String
  amount        Decimal
  confirmed     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([year, statementType, lineItem])
}

model WorkingCapitalRatios {
  id                     String   @id @default(uuid())
  arPercent              Decimal
  prepaidPercent         Decimal
  apPercent              Decimal
  accruedPercent         Decimal
  deferredRevenuePercent Decimal
  locked                 Boolean  @default(true)
  calculatedFrom2024     DateTime
}

model CapExAsset {
  id              String            @id @default(uuid())
  proposalId      String?
  categoryId      String
  purchaseYear    Int               /// 2025 or later (NEW investments only)
  purchaseAmount  Decimal           @db.Decimal(18, 2)
  usefulLife      Int               /// Copied from category at time of creation
  createdAt       DateTime          @default(now())

  // Relations
  proposal LeaseProposal? @relation("ProposalAssets", fields: [proposalId], references: [id], onDelete: SetNull)
  category CapExCategory  @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@index([categoryId])
  @@index([proposalId])
  @@index([proposalId, purchaseYear]) // PERF: Year-based asset queries for CapEx calculations
  @@index([categoryId, purchaseYear]) // PERF: Dashboard CapEx aggregation by category + year range
  @@index([proposalId, categoryId]) // PERF: Per-proposal category summaries
}

model CapExCategory {
  id                String            @id @default(uuid())
  type              CapExCategoryType @unique /// Fixed category type (IT_EQUIPMENT, FURNITURE, etc.)
  name              String            /// Display name for the category
  usefulLife        Int               /// Years for straight-line depreciation of NEW assets
  reinvestFrequency Int?              /// Years between auto-reinvestments (null = no reinvestment)
  reinvestAmount    Decimal?          @db.Decimal(18, 2) /// Fixed SAR amount per reinvestment cycle
  reinvestStartYear Int?              /// Year when auto-reinvestment begins (e.g., 2029). Null = starts from 2028
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  assets            CapExAsset[]
  transitionData    CapExTransition[]

  @@index([type])
}

model CapExTransition {
  id          String        @id @default(uuid())
  proposalId  String
  categoryId  String
  year        Int           /// 2025, 2026, or 2027
  amount      Decimal       @db.Decimal(18, 2)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  proposal LeaseProposal @relation("ProposalTransitionCapex", fields: [proposalId], references: [id], onDelete: Cascade)
  category CapExCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@unique([proposalId, categoryId, year])
  @@index([proposalId])
  @@index([categoryId])
}

model CapExConfig {
  id                      String   @id @default(uuid())
  autoReinvestEnabled     Boolean  @default(false)
  reinvestFrequency       Int?
  reinvestAmount          Decimal?
  reinvestAmountPercent   Decimal?
  useCategoryReinvestment Boolean  @default(false) /// When true, use per-category reinvestment instead of global
}

model TransitionConfig {
  id                 String   @id @default(uuid())
  year2025Students   Int
  year2025AvgTuition Decimal
  year2026Students   Int
  year2026AvgTuition Decimal
  year2027Students   Int
  year2027AvgTuition Decimal
  rentGrowthPercent  Decimal   /// Decimal fraction (e.g., 0.05 = 5%)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  updatedBy          String?
}

model Negotiation {
  id          String            @id @default(uuid())
  developer   String            /// Developer/landlord company name
  property    String            /// Property/site name
  status      NegotiationStatus @default(ACTIVE)
  notes       String?           /// General negotiation notes
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdBy   String

  // Relations
  creator     User              @relation("NegotiationCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  proposals   LeaseProposal[]   @relation("NegotiationProposals")

  // Unique constraint: one negotiation per developer+property combination
  @@unique([developer, property])
  @@index([status])
  @@index([createdBy])
  @@index([status, updatedAt]) // PERF: Sorting active negotiations by date
}

model LeaseProposal {
  id           String    @id @default(uuid())
  name         String
  rentModel    String
  createdBy    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  enrollment   Json
  curriculum   Json
  staff        Json
  rentParams   Json
  otherOpexPercent Decimal  /// % of revenue as decimal (e.g., 0.31 = 31%)
  financials   Json?
  metrics      Json?
  calculatedAt DateTime?
  transitionConfigUpdatedAt DateTime? @map("transition_config_updated_at") /// Audit trail for which TransitionConfig was used

  // Contract Period Configuration
  contractPeriodYears Int @default(30) @db.Integer /// Dynamic period length: 25 years (2028-2052) or 30 years (2028-2057)

  // Negotiation Context (v2.2)
  negotiationId    String?                              /// FK to Negotiation entity (null for stress tests/simulations)
  purpose          ProposalPurpose @default(SIMULATION) /// NEGOTIATION | STRESS_TEST | SIMULATION
  offerNumber      Int?                                 /// Simple counter: 1, 2, 3... (null for non-negotiation proposals)
  developer        String?                              /// DEPRECATED: Use negotiation.developer instead
  property         String?                              /// DEPRECATED: Use negotiation.property instead
  negotiationRound Int            @default(1)          /// DEPRECATED: Use offerNumber instead
  version          String?
  origin           ProposalOrigin @default(OUR_OFFER)
  status           ProposalStatus @default(DRAFT)
  parentProposalId String?

  // Timeline Tracking (v2.1)
  submittedDate        DateTime?
  responseReceivedDate DateTime?

  // Notes & Context (v2.1)
  negotiationNotes String?
  boardComments    String?

  // Relations
  creator              User                   @relation("ProposalCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  negotiation          Negotiation?           @relation("NegotiationProposals", fields: [negotiationId], references: [id], onDelete: SetNull)
  assets               CapExAsset[]           @relation("ProposalAssets")
  transitionCapex      CapExTransition[]      @relation("ProposalTransitionCapex")
  parentProposal       LeaseProposal?         @relation("ProposalVersions", fields: [parentProposalId], references: [id], onDelete: SetNull)
  childProposals       LeaseProposal[]        @relation("ProposalVersions")
  scenarios            Scenario[]             @relation("ProposalScenarios")
  sensitivityAnalyses  SensitivityAnalysis[]  @relation("ProposalSensitivityAnalyses")

  // Indexes for negotiation queries (v2.2)
  @@index([negotiationId, offerNumber], name: "idx_negotiation_offers")
  @@index([purpose], name: "idx_purpose")
  @@index([developer, property, negotiationRound], name: "idx_negotiation_thread") // DEPRECATED: kept for backward compatibility
  @@index([status], name: "idx_status")

  // PERFORMANCE OPTIMIZATION: Additional indexes for common queries
  @@index([createdBy], name: "idx_created_by")
  @@index([createdAt], name: "idx_created_at")
  @@index([rentModel], name: "idx_rent_model")
  @@index([createdAt, createdBy], name: "idx_created_composite")
  @@index([calculatedAt], name: "idx_calculated_at") // For dashboard metrics query
  @@index([createdBy, status], name: "idx_creator_status") // PERF: "My proposals by status" queries
}

model Scenario {
  id         String   @id @default(uuid())
  proposalId String
  name       String
  createdAt  DateTime @default(now())
  createdBy  String

  // Scenario Variables (adjustable sliders)
  enrollmentPercent     Decimal // % of baseline (e.g., 100 = baseline, 120 = 20% increase)
  cpiPercent            Decimal // Annual CPI growth % (e.g., 3.0 = 3%)
  tuitionGrowthPercent  Decimal // Annual tuition growth % (e.g., 5.0 = 5%)
  rentEscalationPercent Decimal // Annual rent escalation % (e.g., 3.0 = 3%)

  // Calculated Metrics (stored for quick comparison)
  totalRent   Decimal?
  npv         Decimal?
  totalEbitda Decimal?
  finalCash   Decimal?
  maxDebt     Decimal?

  // Relations
  proposal LeaseProposal @relation("ProposalScenarios", fields: [proposalId], references: [id], onDelete: Cascade)
  creator  User          @relation("ScenarioCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([proposalId])
}

model SensitivityAnalysis {
  id         String   @id @default(uuid())
  proposalId String
  name       String?
  createdAt  DateTime @default(now())
  createdBy  String

  // Configuration
  variable     String  // Which variable to test (enrollment, cpi, tuitionGrowth, rentEscalation)
  rangeMin     Decimal // Minimum value for the range (e.g., -20 for -20%)
  rangeMax     Decimal // Maximum value for the range (e.g., +20 for +20%)
  impactMetric String  // Which metric to measure impact on (npv, totalRent, totalEbitda, etc.)

  // Results (stored as JSON for flexibility)
  dataPoints Json? // Array of {inputValue, outputValue} for tornado chart
  tornadoData Json? // Processed tornado chart data

  // Relations
  proposal LeaseProposal @relation("ProposalSensitivityAnalyses", fields: [proposalId], references: [id], onDelete: Cascade)
  creator  User          @relation("SensitivityAnalysisCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([proposalId])
}
